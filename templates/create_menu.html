<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Create Menu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Include Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        .box {
            margin-bottom: 1rem;
        }

        #loading {
            display: none;
        }

        #menu {
            display: none;
        }

        .category-header {
            cursor: pointer;
            user-select: none;
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
        }

        .remove-button {
            margin-left: 0.5rem;
        }
    </style>
</head>

<body>

    <section class="section">
        <div class="container">
            <h1 class="title">Create Menu</h1>

            <!-- File Input and Parse Button -->
            <div id="imageupload" class="field">
                <label class="label">Upload Menu Image</label>
                <div class="control">
                    <input class="input" type="file" id="menu-image" accept="image/*">
                </div>
                <figure class="image is-128x128">
                    <img id="image-preview" src="#" alt="Image Preview" style="display: none;">
                </figure>
                <button class="button is-link" id="parse-button" type="button" disabled>Parse</button>
            </div>

            <div id="loading">
                <progress class="progress is-small is-primary" max="100">Loading...</progress>
            </div>

            <!-- Form for Menu Creation -->
            <div id="menu">
                <form action="/save_menu" method="post" id="menu-form">
                    <input type="hidden" name="id" value="{{ id }}">
                    <!-- Restaurant Name -->
                    <div class="field">
                        <label class="label">Restaurant Name</label>
                        <div class="control">
                            <input class="input" type="text" name="restaurant" placeholder="Restaurant Name" required>
                        </div>
                    </div>
                    <!-- Contact Information -->
                    <div class="field">
                        <label class="label">Contact</label>
                        <div class="control">
                            <input class="input" type="text" name="contact" placeholder="Contact Information">
                        </div>
                    </div>
                    <!-- Theme -->
                    <div class="field">
                        <label class="label">Theme</label>
                        <div class="control">
                            <input class="input" type="text" name="theme" value="olive">
                        </div>
                    </div>
                    <!-- Categories and Items -->
                    <div class="field">
                        <label class="label">Categories</label>
                        <div id="categories-container">
                            <!-- Categories will be dynamically added here -->
                        </div>
                        <button type="button" class="button is-link is-light" id="add-category-button">Add Category</button>
                    </div>
                    <!-- Submit Button -->
                    <div class="field">
                        <div class="control">
                            <button class="button is-primary" type="submit">Save Menu</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- JavaScript Section -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuImageInput = document.getElementById('menu-image');
            const imagePreview = document.getElementById('image-preview');
            const parseButton = document.getElementById('parse-button');
            const menuForm = document.getElementById('menu-form');
            const categoriesContainer = document.getElementById('categories-container');

            const imageUploadDiv = document.getElementById("imageupload")
            const loadingDiv = document.getElementById("loading")
            const menuDiv = document.getElementById("menu")

            const addCategoryButton = document.getElementById('add-category-button');

            // Index trackers
            let categoryIndex = 0;

            // Handle Image Selection
            menuImageInput.addEventListener('change', () => {
                const file = menuImageInput.files[0];
                if (file) {
                    // Show the image thumbnail
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                    parseButton.disabled = false;
                } else {
                    imagePreview.src = '#';
                    imagePreview.style.display = 'none';
                    parseButton.disabled = true;
                }
            });

            // Handle Parse Button Click
            parseButton.addEventListener('click', async () => {
                event.preventDefault();
                const file = menuImageInput.files[0];
                if (!file) {
                    alert('Please select an image.');
                    return;
                }

                parseButton.disabled = true;
                parseButton.textContent = 'Parsing...';

                imageUploadDiv.style.display = "none";
                loadingDiv.style.display = "block";

                try {
                    // Convert image to base64
                    const base64Image = await toBase64(file);

                    // Send image to server for parsing
                    const response = await fetch('/parse_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ image: base64Image }),
                    });

                    if (!response.ok) {
                        throw new Error('Error parsing image.');
                    }

                    const data = await response.json();

                    // Prefill the form with parsed data
                    prefillForm(data);

                    parseButton.textContent = 'Parse';
                    parseButton.disabled = false;
                    loadingDiv.style.display = "none";
                    menuDiv.style.display = "block";
                } catch (error) {
                    console.error(error);
                    alert('An error occurred while parsing the image.');
                    parseButton.textContent = 'Parse';
                    parseButton.disabled = false;
                    loadingDiv.style.display = "none";
                    imageUploadDiv.style.display = "block";
                }
            });

            // Helper function to convert image to base64
            function toBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        resolve(e.target.result.split(',')[1]); // Remove data:image/*;base64,
                    };
                    reader.onerror = function (error) {
                        reject(error);
                    };
                    reader.readAsDataURL(file);
                });
            }

            function prefillForm(parsedData) {
                // Clear existing categories
                categoriesContainer.innerHTML = '';

                // Reset category index
                categoryIndex = 0;

                // Set restaurant name, contact, and theme
                menuForm.elements['restaurant'].value = parsedData.restaurant || '';
                menuForm.elements['contact'].value = parsedData.contact || '';
                menuForm.elements['theme'].value = parsedData.theme || 'olive';

                // Iterate over categories
                parsedData.menu.categories.forEach((category) => {
                    addCategory(category);
                });
            }

            // Function to add a new category
            function addCategory(categoryData = null) {
                const i = categoryIndex++;

                const categoryBox = document.createElement('div');
                categoryBox.classList.add('box', 'category-box');

                // Category Header (Accordion)
                const categoryHeader = document.createElement('div');
                categoryHeader.classList.add('category-header', 'is-flex', 'is-align-items-center');
                const categoryTitle = document.createElement('span');
                categoryTitle.textContent = categoryData ? categoryData.name || `Category ${i + 1}` : `Category ${i + 1}`;
                categoryTitle.style.flexGrow = '1';

                // Category Name Input
                const categoryNameInput = document.createElement('input');
                categoryNameInput.type = 'hidden';
                categoryNameInput.name = `category_name_${i}`;
                categoryNameInput.value = categoryData ? categoryData.name || '' : '';

                // Remove Category Button
                const removeCategoryButton = document.createElement('button');
                removeCategoryButton.type = 'button';
                removeCategoryButton.classList.add('button', 'is-small', 'is-danger', 'remove-button');
                removeCategoryButton.textContent = 'Remove Category';

                removeCategoryButton.addEventListener('click', () => {
                    categoriesContainer.removeChild(categoryBox);
                });

                // Toggle category content visibility
                categoryHeader.addEventListener('click', () => {
                    categoryContent.classList.toggle('active');
                });

                categoryHeader.appendChild(categoryTitle);
                categoryHeader.appendChild(removeCategoryButton);
                categoryHeader.appendChild(categoryNameInput);

                // Category Content
                const categoryContent = document.createElement('div');
                categoryContent.classList.add('category-content');

                // Edit Category Name Field
                const editCategoryNameField = document.createElement('div');
                editCategoryNameField.classList.add('field');
                const editCategoryNameLabel = document.createElement('label');
                editCategoryNameLabel.classList.add('label');
                editCategoryNameLabel.textContent = 'Category Name';
                const editCategoryNameControl = document.createElement('div');
                editCategoryNameControl.classList.add('control');
                const editCategoryNameInput = document.createElement('input');
                editCategoryNameInput.classList.add('input');
                editCategoryNameInput.type = 'text';
                editCategoryNameInput.value = categoryData ? categoryData.name || '' : '';
                editCategoryNameInput.addEventListener('input', () => {
                    categoryNameInput.value = editCategoryNameInput.value;
                    categoryTitle.textContent = editCategoryNameInput.value || `Category ${i + 1}`;
                });

                editCategoryNameControl.appendChild(editCategoryNameInput);
                editCategoryNameField.appendChild(editCategoryNameLabel);
                editCategoryNameField.appendChild(editCategoryNameControl);

                categoryContent.appendChild(editCategoryNameField);

                // Items Container
                const itemsContainer = document.createElement('div');
                itemsContainer.classList.add('items-container');

                categoryContent.appendChild(itemsContainer);

                // Add Item Button
                const addItemButton = document.createElement('button');
                addItemButton.type = 'button';
                addItemButton.classList.add('button', 'is-small', 'is-link', 'is-light', 'add-item-button');
                addItemButton.textContent = 'Add Item';

                addItemButton.addEventListener('click', () => {
                    addItem(i, itemsContainer);
                });

                categoryContent.appendChild(addItemButton);

                // Append existing items
                if (categoryData && categoryData.items) {
                    categoryData.items.forEach((item) => {
                        addItem(i, itemsContainer, item);
                    });
                }

                categoryBox.appendChild(categoryHeader);
                categoryBox.appendChild(categoryContent);
                categoriesContainer.appendChild(categoryBox);
            }

            // Function to add a new item to a category
            function addItem(categoryIndex, itemsContainer, itemData = null) {
                const itemIndex = itemsContainer.childElementCount;

                const itemBox = document.createElement('div');
                itemBox.classList.add('box', 'item-box');

                // Remove Item Button
                const removeItemButton = document.createElement('button');
                removeItemButton.type = 'button';
                removeItemButton.classList.add('button', 'is-small', 'is-danger', 'remove-button');
                removeItemButton.textContent = 'Remove Item';

                removeItemButton.addEventListener('click', () => {
                    itemsContainer.removeChild(itemBox);
                });

                // Item Name
                const itemNameField = createInputField(`Item Name`, `item_name_${categoryIndex}_${itemIndex}`, itemData ? itemData.name || '' : '');

                // Item Price
                const itemPriceField = createInputField(`Item Price`, `item_price_${categoryIndex}_${itemIndex}`, itemData ? itemData.price || '' : '');

                // Item Description
                const itemDescField = createTextareaField(`Item Description`, `item_description_${categoryIndex}_${itemIndex}`, itemData ? itemData.description || '' : '');

                itemBox.appendChild(removeItemButton);
                itemBox.appendChild(itemNameField);
                itemBox.appendChild(itemPriceField);
                itemBox.appendChild(itemDescField);

                itemsContainer.appendChild(itemBox);
            }

            // Helper function to create input fields
            function createInputField(labelText, inputName, inputValue) {
                const field = document.createElement('div');
                field.classList.add('field');
                const label = document.createElement('label');
                label.classList.add('label');
                label.textContent = labelText;
                const control = document.createElement('div');
                control.classList.add('control');
                const input = document.createElement('input');
                input.classList.add('input');
                input.type = 'text';
                input.name = inputName;
                input.value = inputValue;

                control.appendChild(input);
                field.appendChild(label);
                field.appendChild(control);

                return field;
            }

            // Helper function to create textarea fields
            function createTextareaField(labelText, textareaName, textareaValue) {
                const field = document.createElement('div');
                field.classList.add('field');
                const label = document.createElement('label');
                label.classList.add('label');
                label.textContent = labelText;
                const control = document.createElement('div');
                control.classList.add('control');
                const textarea = document.createElement('textarea');
                textarea.classList.add('textarea');
                textarea.name = textareaName;
                textarea.value = textareaValue;

                control.appendChild(textarea);
                field.appendChild(label);
                field.appendChild(control);

                return field;
            }

            // Event listener for Add Category button
            addCategoryButton.addEventListener('click', () => {
                addCategory();
            });
        });
    </script>
</body>

</html>
