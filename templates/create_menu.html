<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Create Menu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Include Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>

        .label {
            font-size: 13px;
        }
        .box {
            margin-bottom: 1rem;
            padding: 2%;
        }

        .section {
            padding: 2%;
        }

        #loading {
            display: none;
        }

        #menu {
            display: none;
        }

        .category-header {
            cursor: pointer;
            user-select: none;
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
        }

        .remove-button {
            margin-left: 0.5rem;
        }

        .level {
            display: flex;
        }
    </style>
</head>

<body>

    <section class="section">
        <div class="container">
            <h1 class="title has-text-centered">Create Menu</h1>

            <!-- File Input and Parse Button -->
            <div id="imageupload" class="field">
                <label class="label">Upload Menu Image</label>
                <div class="level">
                    <div class="level-left">
                        <button class="button is-link" id="parse-button" type="button" disabled>Parse</button>
                    </div>
                    <div class="level-right">
                        <button class="button is-link" id="parse-manual" type="button">Mannual</button>
                    </div>
                </div>
                <div class="control has-text-centered">
                    <button class="button" id="gallery-button" type="button">Select from Gallery</button>
                    <br>
                    <button class="button" id="camera-button" type="button">Take Photo</button>
                    <!-- Hidden file inputs -->
                    <input class="input" type="file" id="gallery-input" accept="image/*" style="display: none;">
                    <input class="input" type="file" id="camera-input" accept="image/*" capture="environment"
                        style="display: none;">
                </div>
                <div class="level">
                    <div class="level-item">
                        <figure class="image is-128x128 has-text-centered">
                            <img id="image-preview" src="#" alt="Image Preview" style="display: none;">
                        </figure>
                    </div>
                </div>
                
            </div>

            <div id="loading">
                <progress class="progress is-small is-primary" max="100">Loading...</progress>
            </div>

            <!-- Form for Menu Creation -->
            <div id="menu">
                <form action="/save_menu" method="post" id="menu-form">
                     <!-- Submit Button -->
                     <div class="field has-text-centered">
                        <div class="control">
                            <button class="button is-primary" type="submit">Save Menu</button>
                        </div>
                    </div>
                    <input type="hidden" name="id" value="{{ id }}">
                    <!-- Restaurant Name -->
                    <div class="field">
                        <label class="label">Restaurant Name</label>
                        <div class="control">
                            <input class="input" type="text" name="restaurant" placeholder="Restaurant Name" required>
                        </div>
                    </div>
                    <!-- Contact Information -->
                    <div class="field">
                        <label class="label">Contact</label>
                        <div class="control">
                            <input class="input" type="text" name="contact" placeholder="Contact Information">
                        </div>
                    </div>
                    <!-- Theme -->
                    <div id="theme-input" class="field has-text-centered">
                        <label class="label">Theme</label>
                        <div class="control">
                            <!-- Olive Theme Option -->
                            <label class="radio">
                                <input type="radio" name="theme" value="none">
                                Brez
                            </label>
                            
                            <label class="radio">
                                <input type="radio" name="theme" value="olive">
                                Olive
                            </label>
                    
                            <!-- Blue Theme Option -->
                            <label class="radio">
                                <input type="radio" name="theme" value="blue">
                                Dark
                            </label>
                    
                            <!-- Red Theme Option -->
                            <label class="radio">
                                <input type="radio" name="theme" value="red">
                                Light
                            </label>
                        </div>
                    </div>
                    
                    <!-- Categories and Items -->
                    <div class="field">
                        <div class="level">
                            <div class="level-left">
                                <label class="label">Categories</label>
                            </div>
                            <div class="level-right">
                            </div>
                        </div>
                        <div id="categories-container">
                            <!-- Categories will be dynamically added here -->
                        </div>
                        <button type="button" class="button is-link is-light" id="add-category-button">Add Category</button>

                    </div>
                   
                </form>
            </div>
        </div>
    </section>

    <!-- JavaScript Section -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const imagePreview = document.getElementById('image-preview');
            const parseButton = document.getElementById('parse-button');
            const parseManualButton = document.getElementById("parse-manual");
            const menuForm = document.getElementById('menu-form');
            const categoriesContainer = document.getElementById('categories-container');
            const themeInput = document.getElementById("theme-input");

            const imageUploadDiv = document.getElementById("imageupload");
            const loadingDiv = document.getElementById("loading");
            const menuDiv = document.getElementById("menu");

            const galleryButton = document.getElementById('gallery-button');
            const cameraButton = document.getElementById('camera-button');
            const galleryInput = document.getElementById('gallery-input');
            const cameraInput = document.getElementById('camera-input');

            const addCategoryButton = document.getElementById('add-category-button');

            // Array to keep track of categories
            let categoriesList = [];


            // Variable to store the selected file
            let selectedFile = null;

            // Handle gallery button click
            galleryButton.addEventListener('click', () => {
                galleryInput.click();
            });

            // Handle camera button click
            cameraButton.addEventListener('click', () => {
                cameraInput.click();
            });

            loadedCssFiles = [];
            

            // Handle image selection
            function handleImageSelection(input) {
                const file = input.files[0];
                if (file) {
                    // Show the image thumbnail
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                    parseButton.disabled = false;
                    // Store the selected file
                    selectedFile = file;
                } else {
                    imagePreview.src = '#';
                    imagePreview.style.display = 'none';
                    parseButton.disabled = true;
                    selectedFile = null;
                }
            }



            galleryInput.addEventListener('change', () => {
                handleImageSelection(galleryInput);
            });

            cameraInput.addEventListener('change', () => {
                handleImageSelection(cameraInput);
            });

            parseManualButton.addEventListener('click', () => {
                // Initialize with an empty category if no data is parsed
                prefillForm({
                    restaurant: "",
                    contact: "",
                    theme: "",
                    menu: {
                        categories: []
                    }
                });
                if (categoriesContainer.childElementCount === 0) {
                    addCategory();
                    menuDiv.style.display = "block";
                }
                imageUploadDiv.style.display = "none";
                menuDiv.style.display = "block";
            })

            function longUrl(url) {
                return "/static/theme_" + url + ".css"
            }

            // Handle Parse Button Click
            parseButton.addEventListener('click', async (event) => {
                event.preventDefault();
                const file = selectedFile;
                if (!file) {
                    alert('Please select an image.');
                    return;
                }

                parseButton.disabled = true;
                parseButton.textContent = 'Parsing...';

                imageUploadDiv.style.display = "none";
                loadingDiv.style.display = "block";

                try {
                    // Convert image to base64
                    const base64Image = await toBase64(file);

                    // Send image to server for parsing
                    const response = await fetch('/parse_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ image: base64Image }),
                    });

                    if (!response.ok) {
                        throw new Error('Error parsing image.');
                    }

                    const data = await response.json();

                    // Prefill the form with parsed data
                    prefillForm(data);

                    parseButton.textContent = 'Parse';
                    parseButton.disabled = false;
                    loadingDiv.style.display = "none";
                    menuDiv.style.display = "block";
                } catch (error) {
                    console.error(error);
                    alert('An error occurred while parsing the image.');
                    parseButton.textContent = 'Parse';
                    parseButton.disabled = false;
                    loadingDiv.style.display = "none";
                    imageUploadDiv.style.display = "block";
                }
            });

            // Helper function to convert image to base64
            function toBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        resolve(e.target.result.split(',')[1]); // Remove data:image/*;base64,
                    };
                    reader.onerror = function (error) {
                        reject(error);
                    };
                    reader.readAsDataURL(file);
                });
            }
            function prefillForm(parsedData) {
                // Clear existing categories
                categoriesContainer.innerHTML = '';

                // Reset category index
                categoryIndex = 0;

                // Set restaurant name, contact, and theme
                menuForm.elements['restaurant'].value = parsedData.restaurant || '';
                menuForm.elements['contact'].value = parsedData.contact || '';
                menuForm.elements['theme'].value = parsedData.theme || '';

                // Iterate over categories
                parsedData.menu.categories.forEach((category) => {
                    addCategory(category);
                });
                
                themeInput.addEventListener("change", (event) => {
                    while (loadedCssFiles.length > 0) {
                        let url = loadedCssFiles.pop();
                        unloadCss(url)
                    }
                    
                    loadCss(longUrl(event.target.value))
                })
            }

            function moveItemToCategory(itemBox, newCategoryIndex) {
                const oldCategoryIndex = parseInt(itemBox.dataset.categoryIndex);
                const itemIndex = parseInt(itemBox.dataset.itemIndex);

                // Remove itemBox from old category's items container
                const oldCategory = categoriesList.find(cat => cat.index === oldCategoryIndex);
                oldCategory.itemsContainer.removeChild(itemBox);

                // Update the categoryIndex in itemBox
                itemBox.dataset.categoryIndex = newCategoryIndex;

                // Add itemBox to new category's items container
                const newCategory = categoriesList.find(cat => cat.index === newCategoryIndex);
                newCategory.itemsContainer.appendChild(itemBox);

                // Reindex items in old category
                reindexItemsInCategory(oldCategoryIndex);

                // Reindex items in new category
                reindexItemsInCategory(newCategoryIndex);
            }

            function reindexItemsInCategory(categoryIndex) {
                const category = categoriesList.find(cat => cat.index === categoryIndex);
                const itemsContainer = category.itemsContainer;
                const itemBoxes = itemsContainer.querySelectorAll('.item-box');
                itemBoxes.forEach((itemBox, index) => {
                    itemBox.dataset.itemIndex = index;
                    // Update the name attributes
                    updateItemNameAttributes(itemBox, categoryIndex, index);
                });
            }


            function addCategory(categoryData = null) {
                const i = categoryIndex++;

                const categoryBox = document.createElement('div');
                categoryBox.classList.add('box', 'category-box');
                categoryBox.dataset.categoryIndex = i; // Store the category index

                // Category Header (Accordion)
                const categoryHeader = document.createElement('div');
                categoryHeader.classList.add('category-header', 'is-flex', 'is-align-items-center');
                const categoryTitle = document.createElement('span');
                categoryTitle.textContent = categoryData ? categoryData.name || `Category ${i + 1}` : `Category ${i + 1}`;
                categoryTitle.style.flexGrow = '1';

                // Category Name Input
                const categoryNameInput = document.createElement('input');
                categoryNameInput.type = 'hidden';
                categoryNameInput.name = `category_name_${i}`;
                categoryNameInput.value = categoryData ? categoryData.name || '' : '';

                // Remove Category Button
                const removeCategoryButton = document.createElement('button');
                removeCategoryButton.type = 'button';
                removeCategoryButton.classList.add('button', 'is-small', 'is-danger', 'remove-button');
                removeCategoryButton.textContent = 'Remove Category';

                removeCategoryButton.addEventListener('click', () => {
                    categoriesContainer.removeChild(categoryBox);
                    updateCategoryOptionsInItems();
                });

                // Toggle category content visibility
                categoryHeader.addEventListener('click', () => {
                    categoryContent.classList.toggle('active');
                });

                categoryHeader.appendChild(categoryTitle);
                categoryHeader.appendChild(removeCategoryButton);
                categoryHeader.appendChild(categoryNameInput);

                // Category Content
                const categoryContent = document.createElement('div');
                categoryContent.classList.add('category-content');

                // Edit Category Name Field
                const editCategoryNameField = document.createElement('div');
                editCategoryNameField.classList.add('field');
                const editCategoryNameLabel = document.createElement('label');
                editCategoryNameLabel.classList.add('label');
                editCategoryNameLabel.textContent = 'Category Name';
                const editCategoryNameControl = document.createElement('div');
                editCategoryNameControl.classList.add('control');
                const editCategoryNameInput = document.createElement('input');
                editCategoryNameInput.classList.add('input');
                editCategoryNameInput.type = 'text';
                editCategoryNameInput.value = categoryData ? categoryData.name || '' : '';
                editCategoryNameInput.addEventListener('input', () => {
                    categoryNameInput.value = editCategoryNameInput.value;
                    categoryTitle.textContent = editCategoryNameInput.value || `Category ${i + 1}`;
                });

                editCategoryNameControl.appendChild(editCategoryNameInput);
                editCategoryNameField.appendChild(editCategoryNameLabel);
                editCategoryNameField.appendChild(editCategoryNameControl);

                categoryContent.appendChild(editCategoryNameField);

                // Items Container
                const itemsContainer = document.createElement('div');
                itemsContainer.classList.add('items-container');

                categoryContent.appendChild(itemsContainer);

                // Add Item Button
                const buttonContainer = document.createElement('div');
                buttonContainer.classList.add('items-container');
                categoryContent.appendChild(buttonContainer);

                const addItemButton = document.createElement('button');
                addItemButton.type = 'button';
                addItemButton.classList.add('button', 'is-small', 'is-link', 'is-light', 'add-item-button');
                addItemButton.textContent = 'Add Item';

                addItemButton.addEventListener('click', () => {
                    addItem(i, itemsContainer);
                });

                buttonContainer.appendChild(addItemButton);

                // Append existing items
                if (categoryData && categoryData.items) {
                    categoryData.items.forEach((item) => {
                        addItem(i, itemsContainer, item);
                    });
                }

                categoryBox.appendChild(categoryHeader);
                categoryBox.appendChild(categoryContent);
                categoriesContainer.appendChild(categoryBox);
                // Add the category to the categoriesList
                categoriesList.push({
                    index: i,
                    nameInput: categoryNameInput,
                    titleElement: categoryTitle,
                    itemsContainer: itemsContainer,
                    categoryBox: categoryBox
                });

                // Update category options in all items
                updateCategoryOptionsInItems();

                // Rest of your existing code...
            }
            function updateItemNameAttributes(itemBox, categoryIndex, itemIndex) {
                // Update the name attributes of inputs in the itemBox
                const inputs = itemBox.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    if (input.name.startsWith('item_name_') || input.name.startsWith('item_price_') || input.name.startsWith('item_description_')) {
                        const nameParts = input.name.split('_');
                        const fieldType = nameParts[0] + '_' + nameParts[1];
                        input.name = `${fieldType}_${categoryIndex}_${itemIndex}`;
                    }
                });
            }

            function updateCategoryOptionsInItems() {
                // For each item in each category, update the category options
                categoriesList.forEach(cat => {
                    const itemsContainer = cat.itemsContainer;
                    const itemBoxes = itemsContainer.querySelectorAll('.item-box');
                    itemBoxes.forEach(itemBox => {
                        const moveCategorySelect = itemBox.querySelector('select');
                        const currentCategoryIndex = parseInt(itemBox.dataset.categoryIndex);
                        // Clear existing options
                        moveCategorySelect.innerHTML = '';
                        // Populate category options
                        categoriesList.forEach(catOption => {
                            const option = document.createElement('option');
                            option.value = catOption.index;
                            option.textContent = catOption.nameInput.value || `Category ${catOption.index + 1}`;
                            if (catOption.index === currentCategoryIndex) {
                                option.selected = true;
                            }
                            moveCategorySelect.appendChild(option);
                        });
                    });
                });
            }


            function addItem(currentCategoryIndex, itemsContainer, itemData = null) {
                const itemIndex = itemsContainer.childElementCount;

                const itemBox = document.createElement('div');
                itemBox.classList.add('box', 'item-box', 'is-description');
                itemBox.dataset.categoryIndex = currentCategoryIndex;
                itemBox.dataset.itemIndex = itemIndex;

                // Remove Item Button
                const removeItemRow = document.createElement('div');
                removeItemRow.classList.add('has-text-right')

                const removeItemButton = document.createElement('button');
                removeItemButton.type = 'button';
                removeItemButton.classList.add('button', 'is-small', 'is-danger', 'remove-button');
                removeItemButton.textContent = 'Remove Item';

                removeItemRow.appendChild(removeItemButton)

                removeItemButton.addEventListener('click', () => {
                    itemsContainer.removeChild(itemBox);
                    // Reindex items in the category
                    reindexItemsInCategory(currentCategoryIndex);
                });

                // Move to Category Dropdown
                const moveCategoryField = document.createElement('div');
                moveCategoryField.classList.add('level');
                const moveCategoryLabel = document.createElement('label');
                moveCategoryLabel.classList.add('level-left');
                moveCategoryLabel.textContent = 'Move to Category';
                const moveCategoryControl = document.createElement('div');
                moveCategoryControl.classList.add('level-right', 'mt-0');
                const moveCategorySelect = document.createElement('select');

                // Populate category options
                categoriesList.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.index;
                    option.textContent = cat.nameInput.value || `Category ${cat.index + 1}`;
                    if (cat.index === currentCategoryIndex) {
                        option.selected = true;
                    }
                    moveCategorySelect.appendChild(option);
                });

                // Event listener for changing category
                moveCategorySelect.addEventListener('change', () => {
                    const newCategoryIndex = parseInt(moveCategorySelect.value);
                    if (newCategoryIndex !== currentCategoryIndex) {
                        moveItemToCategory(itemBox, newCategoryIndex);
                    }
                });

                moveCategoryControl.appendChild(moveCategorySelect);
                moveCategoryField.appendChild(moveCategoryLabel);
                moveCategoryField.appendChild(moveCategoryControl);

                // Item Name
                const itemNameField = createInputField(`Item Name`, `item_name_${currentCategoryIndex}_${itemIndex}`, itemData ? itemData.name || '' : '');

                // Item Price
                const itemPriceField = createInputField(`Item Price`, `item_price_${currentCategoryIndex}_${itemIndex}`, itemData ? itemData.price || '' : '');

                // Item Description
                const itemDescField = createTextareaField(`Item Description`, `item_description_${currentCategoryIndex}_${itemIndex}`, itemData ? itemData.description || '' : '');

                itemBox.appendChild(removeItemRow);
                itemBox.appendChild(itemNameField);
                itemBox.appendChild(itemPriceField);
                itemBox.appendChild(itemDescField);
                itemBox.appendChild(moveCategoryField); 

                itemsContainer.appendChild(itemBox);
            }

            // Helper function to create input fields
            function createInputField(labelText, inputName, inputValue) {
                const field = document.createElement('div');
                field.classList.add('field');
                const label = document.createElement('label');
                label.classList.add('label');
                label.textContent = labelText;
                const control = document.createElement('div');
                control.classList.add('control');
                const input = document.createElement('input');
                input.classList.add('input');
                input.type = 'text';
                input.name = inputName;
                input.value = inputValue;

                control.appendChild(input);
                field.appendChild(label);
                field.appendChild(control);

                return field;
            }

            // Helper function to create textarea fields
            function createTextareaField(labelText, textareaName, textareaValue) {
                const field = document.createElement('div');
                field.classList.add('field');
                const label = document.createElement('label');
                label.classList.add('label');
                label.textContent = labelText;
                const control = document.createElement('div');
                control.classList.add('control');
                const textarea = document.createElement('textarea');
                textarea.classList.add('textarea');
                textarea.name = textareaName;
                textarea.value = textareaValue;

                control.appendChild(textarea);
                field.appendChild(label);
                field.appendChild(control);

                return field;
            }

            // Event listener for Add Category button
            addCategoryButton.addEventListener('click', () => {
                addCategory();
            });
        });

        function loadCss(url) {
            // Check if the CSS is already loaded to prevent duplicates
            if (document.querySelector(`link[href="${url}"]`)) {
                console.warn(`CSS file "${url}" is already loaded.`);
                return;
            }

            // Create a new link element
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = url;
            link.id = `css-${encodeURIComponent(url)}`; // Optional: Assign an ID for easier reference

            // Optionally, handle load and error events
            link.onload = () => {
                console.log(`CSS file "${url}" has been loaded successfully.`);
                loadedCssFiles.push(url)
            };

            link.onerror = () => {
                console.error(`Failed to load CSS file "${url}".`);
            };

            // Append the link element to the head
            document.head.appendChild(link);
        }


        function unloadCss(url) {
            console.log("unloading " + url + "...")
            // Select all link elements with the matching href
            const links = document.querySelectorAll(`link[href="${url}"]`);

            if (links.length === 0) {
                console.warn(`No CSS file found with URL "${url}".`);
                return;
            }

            // Remove each found link element from the head
            links.forEach(link => {
                if (link.parentNode) {
                    link.parentNode.removeChild(link);
                    console.log(`CSS file "${url}" has been unloaded.`);
                }
            });


        }

    </script>
</body>

</html>